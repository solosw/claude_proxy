import{_ as ue,r as b,h as me,i as fe,j as ce,c as g,o as m,a as u,k as _e,b as a,w as n,f as c,l as ve,m as q,g as C,E as x,d as _,t as I,n as N,F as Q,p as H,q as ye,s as be,e as ge,v as he}from"./index-DCTd3nXU.js";const Ve={class:"p-6"},we={class:"flex items-center justify-between mb-4"},ke={key:1,class:"text-gray-400"},xe={key:0},Ie={key:1,class:"text-gray-400"},Ae={key:0,class:"text-gray-400"},Se={key:1},Ue={key:2},Ce={key:0,class:"form-hint"},Oe={class:"dialog-footer"},Re={class:"chat-toolbar"},Pe={class:"chat-meta"},qe={class:"chat-meta-title"},De={class:"chat-meta-sub"},Ee={class:"chat-actions"},Me={class:"chat-messages"},Ne={class:"chat-role"},$e={class:"chat-content"},Be={class:"chat-input"},ze={class:"chat-send"},Ke={__name:"ModelsView",setup(Te){const $=b(!1),T=b([]),B=b([]),A=b(!1),O=b(!1),l=me({id:"",name:"",provider:"",interface_type:"",upstream_id:"",api_key:"",base_url:"",description:"",enabled:!0,forward_metadata:!1,forward_thinking:!1,max_qps:0,operator_id:"",response_format:""}),W={id:[{required:!0,message:"请输入模型 ID",trigger:"blur"}],name:[{required:!0,message:"请输入名称",trigger:"blur"}],provider:[{required:!0,message:"请输入服务商标识（如 openai / anthropic）",trigger:"blur"}],upstream_id:[{required:!0,message:"请输入上游模型名",trigger:"blur"}]},J=b(),z=async()=>{$.value=!0;try{const{data:s}=await C.get("/api/models");T.value=s||[]}catch{x.error("加载模型列表失败")}finally{$.value=!1}},G=async()=>{try{const{data:s}=await C.get("/api/operators");B.value=s||[]}catch{B.value=[]}},X=()=>{O.value=!1,Object.assign(l,{id:"",name:"",provider:"",interface_type:"openai",upstream_id:"",api_key:"",base_url:"",description:"",enabled:!0,forward_metadata:!1,forward_thinking:!1,max_qps:0,operator_id:"",response_format:""}),A.value=!0},Y=s=>{O.value=!0,Object.assign(l,s),A.value=!0},Z=()=>{ee(),J.value.validate(async s=>{if(s)try{O.value?(await C.put(`/api/models/${encodeURIComponent(l.id)}`,l),x.success("更新成功")):(await C.post("/api/models",l),x.success("创建成功")),A.value=!1,await z()}catch{x.error("保存失败")}})},j=s=>{he.confirm(`确定要删除模型 ${s.id} 吗？`,"提示",{type:"warning"}).then(async()=>{try{await C.delete(`/api/models/${encodeURIComponent(s.id)}`),x.success("删除成功"),await z()}catch{x.error("删除失败")}}).catch(()=>{})},K=b(!1),D=b(!0),E=b(!1),V=b(null),S=b(""),h=b([]),M=fe(()=>{var s;return((s=V.value)==null?void 0:s.interface_type)||"openai"}),ee=()=>{(l.interface_type==="openai_responses"||l.response_format==="openai_responses"&&l.interface_type!=="openai_responses")&&(l.response_format="")},te=s=>{V.value=s,h.value=[{role:"assistant",content:`正在测试模型：${s.name||s.id}
接口类型：${s.interface_type||"(未设置)"}
上游模型：${s.upstream_id||"(未设置)"}
`}],S.value="",K.value=!0},ae=s=>{if(!s)return;const e=h.value,o=e[e.length-1];if(!o||o.role!=="assistant"){e.push({role:"assistant",content:String(s)});return}o.content+=String(s)},le=s=>{var e,o,d;if(!s)return null;if(s==="[DONE]")return{done:!0};try{const f=JSON.parse(s),v=(d=(o=(e=f==null?void 0:f.choices)==null?void 0:e[0])==null?void 0:o.delta)==null?void 0:d.content;if(typeof v=="string"&&v.length)return{delta:v}}catch{}return null},oe=s=>{var e;if(!s)return null;try{const o=JSON.parse(s);if((o==null?void 0:o.type)==="content_block_delta"&&((e=o==null?void 0:o.delta)!=null&&e.text))return{delta:o.delta.text}}catch{}return null},se=s=>{var e;if(!s)return null;try{const o=JSON.parse(s);if((o==null?void 0:o.type)==="content_delta"&&((e=o==null?void 0:o.delta)!=null&&e.text))return{delta:o.delta.text}}catch{}return null},ne=async s=>{var r;const e=localStorage.getItem("token")||"",o=await fetch("/back/api/chat/test",{method:"POST",headers:{"Content-Type":"application/json",token:e},body:JSON.stringify(s)});if(!o.ok||!o.body){const i=await o.text();throw new Error(i||`HTTP ${o.status}`)}const d=o.body.getReader(),f=new TextDecoder("utf-8");let v="";for(h.value.push({role:"assistant",content:""});;){const{value:i,done:p}=await d.read();if(p)break;v+=f.decode(i,{stream:!0});const U=v.split(/\r?\n/);v=U.pop()||"";for(const w of U){if(!w.startsWith("data:"))continue;const R=w.slice(5).trim();let y=null;if(M.value==="anthropic"?y=oe(R):M.value==="openai_responses"||((r=V.value)==null?void 0:r.response_format)==="openai_responses"?y=se(R):y=le(R),y!=null&&y.done)return;y!=null&&y.delta&&ae(y.delta)}}},F=async()=>{var o,d,f,v;if(!V.value||!S.value.trim()||E.value)return;E.value=!0;const s=S.value.trim();S.value="",h.value.push({role:"user",content:s});const e={model_id:V.value.id,stream:!!D.value,messages:h.value.filter(r=>r.role==="user"||r.role==="assistant").map(r=>({role:r.role,content:r.content}))};try{if(D.value){await ne(e);return}const{data:r}=await C.post("/api/chat/test",e);if(M.value==="anthropic"){const i=((r==null?void 0:r.content)||[]).filter(p=>(p==null?void 0:p.type)==="text").map(p=>(p==null?void 0:p.text)||"").join("");h.value.push({role:"assistant",content:i||JSON.stringify(r)})}else if(M.value==="openai_responses"){const i=((o=r==null?void 0:r.message)==null?void 0:o.content)||JSON.stringify(r);h.value.push({role:"assistant",content:i})}else{const i=(v=(f=(d=r==null?void 0:r.choices)==null?void 0:d[0])==null?void 0:f.message)==null?void 0:v.content;h.value.push({role:"assistant",content:i||JSON.stringify(r)})}}catch(r){x.error("发送失败"),h.value.push({role:"assistant",content:`请求失败：${(r==null?void 0:r.message)||r}`})}finally{E.value=!1}};return ce(()=>{z(),G()}),(s,e)=>{const o=c("el-button"),d=c("el-table-column"),f=c("el-tag"),v=c("el-table"),r=c("el-input"),i=c("el-form-item"),p=c("el-option"),U=c("el-select"),w=c("el-switch"),R=c("el-input-number"),y=c("el-form"),re=c("el-dialog"),ie=c("el-drawer"),de=ve("loading");return m(),g("div",Ve,[u("div",we,[e[20]||(e[20]=u("h2",{class:"text-xl font-semibold"},"模型管理",-1)),a(o,{type:"primary",onClick:X},{default:n(()=>e[19]||(e[19]=[_(" 新建模型 ")])),_:1})]),_e((m(),q(v,{data:T.value,border:"",style:{width:"100%"}},{default:n(()=>[a(d,{prop:"id",label:"ID",width:"220"}),a(d,{prop:"name",label:"名称",width:"180"}),a(d,{prop:"provider",label:"服务商",width:"140"}),a(d,{prop:"interface_type",label:"接口类型",width:"160"}),a(d,{prop:"response_format",label:"响应格式",width:"160"},{default:n(({row:t})=>[t.response_format==="openai_responses"?(m(),q(f,{key:0,type:"info",size:"small"},{default:n(()=>e[21]||(e[21]=[_(" OpenAI Responses ")])),_:1})):(m(),g("span",ke,"Anthropic（默认）"))]),_:1}),a(d,{prop:"base_url",label:"Base URL",width:"260"}),a(d,{prop:"api_key",label:"上游 API Key",width:"260"},{default:n(({row:t})=>[t.api_key?(m(),g("span",xe,"••••••••")):(m(),g("span",Ie,"未配置"))]),_:1}),a(d,{prop:"enabled",label:"启用",width:"80"},{default:n(({row:t})=>[a(f,{type:t.enabled?"success":"info"},{default:n(()=>[_(I(t.enabled?"启用":"停用"),1)]),_:2},1032,["type"])]),_:1}),a(d,{label:"扩展字段",width:"120"},{default:n(({row:t})=>[t.operator_id?(m(),g("span",Ae,"运营商")):(m(),g("span",Se,[t.forward_metadata?(m(),q(f,{key:0,size:"small",type:"info"},{default:n(()=>e[22]||(e[22]=[_("metadata")])),_:1})):N("",!0),t.forward_thinking?(m(),q(f,{key:1,size:"small",type:"info"},{default:n(()=>e[23]||(e[23]=[_("thinking")])),_:1})):N("",!0),!t.forward_metadata&&!t.forward_thinking?(m(),g("span",Ue,"—")):N("",!0)]))]),_:1}),a(d,{prop:"max_qps",label:"QPS",width:"80"},{default:n(({row:t})=>[_(I(t.max_qps>0?t.max_qps:"—"),1)]),_:1}),a(d,{prop:"operator_id",label:"运营商",width:"120"},{default:n(({row:t})=>[_(I(t.operator_id||"—"),1)]),_:1}),a(d,{prop:"description",label:"描述"}),a(d,{label:"操作",width:"260",fixed:"right"},{default:n(({row:t})=>[a(o,{size:"small",type:"primary",onClick:P=>te(t)},{default:n(()=>e[24]||(e[24]=[_("聊天测试")])),_:2},1032,["onClick"]),a(o,{size:"small",onClick:P=>Y(t)},{default:n(()=>e[25]||(e[25]=[_("编辑")])),_:2},1032,["onClick"]),a(o,{size:"small",type:"danger",onClick:P=>j(t)},{default:n(()=>e[26]||(e[26]=[_("删除")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[de,$.value]]),a(re,{modelValue:A.value,"onUpdate:modelValue":e[15]||(e[15]=t=>A.value=t),title:O.value?"编辑模型":"新建模型",width:"560px"},{footer:n(()=>[u("span",Oe,[a(o,{onClick:e[14]||(e[14]=t=>A.value=!1)},{default:n(()=>e[32]||(e[32]=[_("取 消")])),_:1}),a(o,{type:"primary",onClick:Z},{default:n(()=>e[33]||(e[33]=[_("确 定")])),_:1})])]),default:n(()=>[a(y,{ref_key:"formRef",ref:J,model:l,rules:W,"label-width":"100px"},{default:n(()=>[a(i,{label:"ID",prop:"id"},{default:n(()=>[a(r,{modelValue:l.id,"onUpdate:modelValue":e[0]||(e[0]=t=>l.id=t),disabled:O.value},null,8,["modelValue","disabled"])]),_:1}),a(i,{label:"名称",prop:"name"},{default:n(()=>[a(r,{modelValue:l.name,"onUpdate:modelValue":e[1]||(e[1]=t=>l.name=t)},null,8,["modelValue"])]),_:1}),a(i,{label:"服务商",prop:"provider"},{default:n(()=>[a(r,{modelValue:l.provider,"onUpdate:modelValue":e[2]||(e[2]=t=>l.provider=t),placeholder:"例如 openai / anthropic"},null,8,["modelValue"])]),_:1}),a(i,{label:"运营商"},{default:n(()=>[a(U,{modelValue:l.operator_id,"onUpdate:modelValue":e[3]||(e[3]=t=>l.operator_id=t),placeholder:"无（直连 OpenAI/Anthropic）",clearable:"",style:{width:"100%"}},{default:n(()=>[(m(!0),g(Q,null,H(B.value,t=>(m(),q(p,{key:t.id,label:t.name||t.id,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),e[27]||(e[27]=u("div",{class:"form-hint"},"选择后，该模型走运营商专属 API（Base URL / API Key 以运营商为准）",-1))]),_:1}),a(i,{label:"接口类型"},{default:n(()=>[a(U,{modelValue:l.interface_type,"onUpdate:modelValue":e[4]||(e[4]=t=>l.interface_type=t),placeholder:"选择接口类型",style:{width:"100%"}},{default:n(()=>[a(p,{label:"OpenAI Chat Completions",value:"openai"}),a(p,{label:"OpenAI 兼容",value:"openai_compatible"}),a(p,{label:"OpenAI Responses API",value:"openai_responses"}),a(p,{label:"Anthropic Messages",value:"anthropic"})]),_:1},8,["modelValue"]),l.operator_id?(m(),g("div",Ce,"归属运营商时可由运营商配置覆盖")):N("",!0)]),_:1}),a(i,{label:"响应格式"},{default:n(()=>[a(U,{modelValue:l.response_format,"onUpdate:modelValue":e[5]||(e[5]=t=>l.response_format=t),placeholder:"选择响应格式（默认 Anthropic）",clearable:"",style:{width:"100%"}},{default:n(()=>[a(p,{label:"Anthropic（默认）",value:""}),a(p,{label:"Anthropic",value:"anthropic"}),a(p,{label:"OpenAI Responses API",value:"openai_responses"})]),_:1},8,["modelValue"]),e[28]||(e[28]=u("div",{class:"form-hint"},"选 OpenAI Responses 接口时也默认为 Anthropic；若需 /back/v1/messages 返回 OpenAI Responses 格式，可在此选择「OpenAI Responses API」",-1))]),_:1}),a(i,{label:"上游模型名",prop:"upstream_id"},{default:n(()=>[a(r,{modelValue:l.upstream_id,"onUpdate:modelValue":e[6]||(e[6]=t=>l.upstream_id=t),placeholder:"例如 gpt-4.1 / claude-3-5-sonnet-20241022"},null,8,["modelValue"])]),_:1}),a(i,{label:"上游 API Key"},{default:n(()=>[a(r,{modelValue:l.api_key,"onUpdate:modelValue":e[7]||(e[7]=t=>l.api_key=t),type:"password","show-password":"",placeholder:l.operator_id?"归属运营商时使用运营商 API Key":"可选：为该模型配置专用上游 API Key"},null,8,["modelValue","placeholder"])]),_:1}),a(i,{label:"Base URL"},{default:n(()=>[a(r,{modelValue:l.base_url,"onUpdate:modelValue":e[8]||(e[8]=t=>l.base_url=t),placeholder:l.operator_id?"归属运营商时使用运营商 Base URL":"可选：为该模型覆盖 Provider 的 BaseURL"},null,8,["modelValue","placeholder"])]),_:1}),a(i,{label:"转发 metadata"},{default:n(()=>[a(w,{modelValue:l.forward_metadata,"onUpdate:modelValue":e[9]||(e[9]=t=>l.forward_metadata=t)},null,8,["modelValue"]),e[29]||(e[29]=u("span",{class:"form-hint-inline"},"部分上游（如 ModelScope）不支持则关闭",-1))]),_:1}),a(i,{label:"转发 thinking"},{default:n(()=>[a(w,{modelValue:l.forward_thinking,"onUpdate:modelValue":e[10]||(e[10]=t=>l.forward_thinking=t)},null,8,["modelValue"]),e[30]||(e[30]=u("span",{class:"form-hint-inline"},"扩展思考，不支持则关闭",-1))]),_:1}),a(i,{label:"最大 QPS"},{default:n(()=>[a(R,{modelValue:l.max_qps,"onUpdate:modelValue":e[11]||(e[11]=t=>l.max_qps=t),min:0,max:100,step:.5},null,8,["modelValue"]),e[31]||(e[31]=u("span",{class:"form-hint-inline"},"0 表示不限制",-1))]),_:1}),a(i,{label:"描述"},{default:n(()=>[a(r,{modelValue:l.description,"onUpdate:modelValue":e[12]||(e[12]=t=>l.description=t),type:"textarea",rows:3},null,8,["modelValue"])]),_:1}),a(i,{label:"启用"},{default:n(()=>[a(w,{modelValue:l.enabled,"onUpdate:modelValue":e[13]||(e[13]=t=>l.enabled=t)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),a(ie,{modelValue:K.value,"onUpdate:modelValue":e[18]||(e[18]=t=>K.value=t),size:"520px","with-header":!0,title:"聊天测试"},{default:n(()=>{var t,P,L;return[u("div",Re,[u("div",Pe,[u("div",qe,I(((t=V.value)==null?void 0:t.name)||((P=V.value)==null?void 0:P.id)),1),u("div",De,"接口类型："+I(((L=V.value)==null?void 0:L.interface_type)||"openai"),1)]),u("div",Ee,[a(w,{modelValue:D.value,"onUpdate:modelValue":e[16]||(e[16]=k=>D.value=k),"active-text":"SSE","inactive-text":"非流式"},null,8,["modelValue"])])]),u("div",Me,[(m(!0),g(Q,null,H(h.value,(k,pe)=>(m(),g("div",{key:pe,class:ye(["chat-bubble",k.role==="user"?"from-user":"from-assistant"])},[u("div",Ne,I(k.role),1),u("div",$e,I(k.content),1)],2))),128))]),u("div",Be,[a(r,{modelValue:S.value,"onUpdate:modelValue":e[17]||(e[17]=k=>S.value=k),type:"textarea",rows:3,placeholder:"输入一段内容测试模型...",onKeydown:be(ge(F,["exact","prevent"]),["enter"])},null,8,["modelValue","onKeydown"]),u("div",ze,[a(o,{type:"primary",loading:E.value,onClick:F},{default:n(()=>e[34]||(e[34]=[_("发送")])),_:1},8,["loading"])])])]}),_:1},8,["modelValue"])])}}},Fe=ue(Ke,[["__scopeId","data-v-75720e3f"]]);export{Fe as default};
