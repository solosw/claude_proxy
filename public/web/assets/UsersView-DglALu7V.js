import{_ as Z,r as v,n as A,p as ee,c as V,o as p,a as s,q as le,b as l,w as a,e as i,s as te,j as w,g as x,E as g,f as m,t as _,v as D,m as ae}from"./index-D6aaOR7C.js";const se={class:"p-6"},ne={class:"flex items-center justify-between mb-4"},oe={class:"filter-panel mb-4"},ie={key:0},ue={key:1,class:"text-gray-400"},re={key:0,class:"form-hint-inline"},de={class:"dialog-footer"},me={key:1,class:"usage-panel"},pe={class:"usage-row"},_e={class:"usage-row"},fe={class:"usage-row"},ve={class:"usage-row"},ce={class:"usage-row"},ye={class:"usage-row"},ge={class:"usage-row"},be={__name:"UsersView",setup(ke){const C=v(!1),T=v([]),U=v(!1),q=v(!1),u=v(null),b=v(!1),c=v(!1),$=v(),o=A({username:"",api_key:"",quota:-1,expire_at:"",is_admin:!1}),N={},d=A({username:"",is_admin:""}),k=async()=>{C.value=!0;try{const n={};d.username&&(n.username=d.username),d.is_admin!==""&&(n.is_admin=d.is_admin);const{data:e}=await x.get("/api/users",{params:n});T.value=e||[]}catch{g.error("加载用户列表失败")}finally{C.value=!1}},R=()=>{c.value=!1,Object.assign(o,{username:"",api_key:"",quota:-1,expire_at:"",is_admin:!1}),b.value=!0},z=()=>{const n="abcdefghijklmnopqrstuvwxyz0123456789";let e="";for(let r=0;r<8;r++)e+=n.charAt(Math.floor(Math.random()*n.length));o.username="user_"+e},K=n=>{c.value=!0,Object.assign(o,{username:n.username,api_key:n.api_key,quota:n.quota,expire_at:n.expire_at?n.expire_at.slice(0,19):"",is_admin:!!n.is_admin}),b.value=!0},P=()=>{$.value.validate(async n=>{if(!n)return;const e={quota:Number(o.quota),is_admin:!!o.is_admin};o.expire_at&&(e.expire_at=new Date(o.expire_at).toISOString());try{c.value?(await x.put(`/api/users/${encodeURIComponent(o.username)}`,e),g.success("更新用户成功")):(await x.post("/api/users",{username:o.username,...e}),g.success("创建用户成功（API Key 已自动生成）")),b.value=!1,await k()}catch{g.error("保存用户失败")}})},Y=async n=>{U.value=!0,q.value=!0;try{const{data:e}=await x.get(`/api/users/${encodeURIComponent(n.username)}/usage`);u.value=e}catch{u.value=null,g.error("加载使用情况失败")}finally{U.value=!1}},O=n=>{ae.confirm(`确定要删除用户 "${n.username}" 吗？此操作不可撤销。`,"删除用户",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await x.delete(`/api/users/${encodeURIComponent(n.username)}`),g.success("用户已删除"),await k()}catch{g.error("删除用户失败")}}).catch(()=>{})},S=()=>{d.username="",d.is_admin="",k()};return ee(k),(n,e)=>{const r=i("el-button"),I=i("el-input"),f=i("el-form-item"),B=i("el-option"),F=i("el-select"),M=i("el-form"),y=i("el-table-column"),H=i("el-tag"),L=i("el-table"),h=i("el-alert"),G=i("el-input-number"),J=i("el-date-picker"),Q=i("el-switch"),E=i("el-dialog"),W=i("el-skeleton"),X=te("loading");return p(),V("div",se,[s("div",ne,[e[11]||(e[11]=s("h2",{class:"text-xl font-semibold"},"用户管理",-1)),l(r,{type:"primary",onClick:R},{default:a(()=>e[10]||(e[10]=[m("新增用户")])),_:1})]),s("div",oe,[l(M,{model:d,layout:"inline",class:"filter-form"},{default:a(()=>[l(f,{label:"用户名"},{default:a(()=>[l(I,{modelValue:d.username,"onUpdate:modelValue":e[0]||(e[0]=t=>d.username=t),placeholder:"搜索用户名",clearable:"",onInput:k},null,8,["modelValue"])]),_:1}),l(f,{label:"管理员"},{default:a(()=>[l(F,{modelValue:d.is_admin,"onUpdate:modelValue":e[1]||(e[1]=t=>d.is_admin=t),placeholder:"全部",clearable:"",onChange:k},{default:a(()=>[l(B,{label:"是",value:"true"}),l(B,{label:"否",value:"false"})]),_:1},8,["modelValue"])]),_:1}),l(f,null,{default:a(()=>[l(r,{onClick:S},{default:a(()=>e[12]||(e[12]=[m("重置")])),_:1})]),_:1})]),_:1},8,["model"])]),le((p(),w(L,{data:T.value,border:"",style:{width:"100%"}},{default:a(()=>[l(y,{prop:"username",label:"用户名",width:"180"}),l(y,{prop:"api_key",label:"API Key",width:"240"},{default:a(({row:t})=>[t.api_key?(p(),V("span",ie,"••••••••")):(p(),V("span",ue,"未设置"))]),_:1}),l(y,{prop:"quota",label:"额度",width:"120"},{default:a(({row:t})=>[m(_(t.quota<0?"无限":t.quota),1)]),_:1}),l(y,{prop:"expire_at",label:"过期时间",width:"220"},{default:a(({row:t})=>[m(_(t.expire_at||"不过期"),1)]),_:1}),l(y,{prop:"is_admin",label:"管理员",width:"120"},{default:a(({row:t})=>[l(H,{type:t.is_admin?"danger":"info"},{default:a(()=>[m(_(t.is_admin?"是":"否"),1)]),_:2},1032,["type"])]),_:1}),l(y,{prop:"total_tokens",label:"总 Token",width:"140"}),l(y,{label:"操作",width:"280",fixed:"right"},{default:a(({row:t})=>[l(r,{size:"small",onClick:j=>K(t)},{default:a(()=>e[13]||(e[13]=[m("编辑")])),_:2},1032,["onClick"]),l(r,{size:"small",type:"primary",onClick:j=>Y(t)},{default:a(()=>e[14]||(e[14]=[m("使用情况")])),_:2},1032,["onClick"]),l(r,{size:"small",type:"danger",onClick:j=>O(t)},{default:a(()=>e[15]||(e[15]=[m("删除")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[X,C.value]]),l(E,{modelValue:b.value,"onUpdate:modelValue":e[8]||(e[8]=t=>b.value=t),title:c.value?"编辑用户":"新增用户",width:"560px"},{footer:a(()=>[s("span",de,[l(r,{onClick:e[7]||(e[7]=t=>b.value=!1)},{default:a(()=>e[18]||(e[18]=[m("取消")])),_:1}),l(r,{type:"primary",onClick:P},{default:a(()=>e[19]||(e[19]=[m("确定")])),_:1})])]),default:a(()=>[l(M,{ref_key:"formRef",ref:$,model:o,rules:N,"label-width":"100px"},{default:a(()=>[l(f,{label:"用户名",prop:"username"},{default:a(()=>[l(I,{modelValue:o.username,"onUpdate:modelValue":e[2]||(e[2]=t=>o.username=t),disabled:!0},null,8,["modelValue"]),c.value?D("",!0):(p(),V("span",re,"系统自动生成"))]),_:1}),c.value?D("",!0):(p(),w(f,{key:0},{default:a(()=>[l(r,{onClick:z},{default:a(()=>e[16]||(e[16]=[m("生成用户名")])),_:1})]),_:1})),c.value?(p(),w(f,{key:1,label:"API Key",prop:"api_key"},{default:a(()=>[l(I,{modelValue:o.api_key,"onUpdate:modelValue":e[3]||(e[3]=t=>o.api_key=t),"show-password":"",disabled:""},null,8,["modelValue"])]),_:1})):(p(),w(h,{key:2,title:"创建用户时用户名和 API Key 由系统自动生成",type:"info",closable:!1,"show-icon":"",class:"mb-3"})),l(f,{label:"额度"},{default:a(()=>[l(G,{modelValue:o.quota,"onUpdate:modelValue":e[4]||(e[4]=t=>o.quota=t),min:-1,step:1e3},null,8,["modelValue"]),e[17]||(e[17]=s("span",{class:"form-hint-inline"},"-1 表示无限",-1))]),_:1}),l(f,{label:"过期时间"},{default:a(()=>[l(J,{modelValue:o.expire_at,"onUpdate:modelValue":e[5]||(e[5]=t=>o.expire_at=t),type:"datetime","value-format":"YYYY-MM-DDTHH:mm:ss",placeholder:"可选，不填表示不过期",style:{width:"100%"},clearable:""},null,8,["modelValue"])]),_:1}),l(f,{label:"管理员"},{default:a(()=>[l(Q,{modelValue:o.is_admin,"onUpdate:modelValue":e[6]||(e[6]=t=>o.is_admin=t)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(E,{modelValue:q.value,"onUpdate:modelValue":e[9]||(e[9]=t=>q.value=t),title:"用户使用情况",width:"520px"},{default:a(()=>[U.value?(p(),w(W,{key:0,rows:6,animated:""})):u.value?(p(),V("div",me,[s("div",pe,[e[20]||(e[20]=s("span",null,"用户名",-1)),s("strong",null,_(u.value.username),1)]),s("div",_e,[e[21]||(e[21]=s("span",null,"输入 Token",-1)),s("strong",null,_(u.value.input_tokens),1)]),s("div",fe,[e[22]||(e[22]=s("span",null,"输出 Token",-1)),s("strong",null,_(u.value.output_tokens),1)]),s("div",ve,[e[23]||(e[23]=s("span",null,"总 Token",-1)),s("strong",null,_(u.value.total_tokens),1)]),s("div",ce,[e[24]||(e[24]=s("span",null,"额度",-1)),s("strong",null,_(u.value.unlimited?"无限":u.value.quota),1)]),s("div",ye,[e[25]||(e[25]=s("span",null,"剩余额度",-1)),s("strong",null,_(u.value.unlimited?"无限":u.value.remaining),1)]),s("div",ge,[e[26]||(e[26]=s("span",null,"过期时间",-1)),s("strong",null,_(u.value.expire_at||"不过期"),1)])])):D("",!0)]),_:1},8,["modelValue"])])}}},we=Z(be,[["__scopeId","data-v-acc3df66"]]);export{we as default};
