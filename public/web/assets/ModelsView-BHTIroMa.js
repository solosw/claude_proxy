import{_ as ue,r as b,n as me,i as fe,p as ce,c as g,o as m,a as p,q as _e,b as l,w as o,e as _,s as ve,j as q,g as O,E as I,f,t as h,v as $,F as Q,l as H,x as ye,y as be,d as ge,m as Ve}from"./index-C8yXOZaD.js";const he={class:"p-6"},we={class:"flex items-center justify-between mb-4"},ke={key:1,class:"text-gray-400"},xe={key:0},Ue={key:1,class:"text-gray-400"},Ie={key:0,class:"text-gray-400"},Se={key:1},Ae={key:2},Ce={key:0,class:"form-hint"},Oe={class:"dialog-footer"},Re={class:"chat-toolbar"},Pe={class:"chat-meta"},qe={class:"chat-meta-title"},De={class:"chat-meta-sub"},Ee={class:"chat-actions"},Ne={class:"chat-messages"},$e={class:"chat-role"},Me={class:"chat-content"},Be={class:"chat-input"},Ke={class:"chat-send"},ze={__name:"ModelsView",setup(Te){const M=b(!1),T=b([]),B=b([]),S=b(!1),R=b(!1),a=me({id:"",name:"",provider:"",interface_type:"",upstream_id:"",api_key:"",base_url:"",description:"",enabled:!0,forward_metadata:!1,forward_thinking:!1,max_qps:0,operator_id:"",response_format:"",input_price:0,output_price:0}),W={id:[{required:!0,message:"请输入模型 ID",trigger:"blur"}],name:[{required:!0,message:"请输入名称",trigger:"blur"}],provider:[{required:!0,message:"请输入服务商标识（如 openai / anthropic）",trigger:"blur"}],upstream_id:[{required:!0,message:"请输入上游模型名",trigger:"blur"}]},J=b(),K=async()=>{M.value=!0;try{const{data:n}=await O.get("/api/models");T.value=n||[]}catch{I.error("加载模型列表失败")}finally{M.value=!1}},G=async()=>{try{const{data:n}=await O.get("/api/operators");B.value=n||[]}catch{B.value=[]}},X=()=>{R.value=!1,Object.assign(a,{id:"",name:"",provider:"",interface_type:"openai",upstream_id:"",api_key:"",base_url:"",description:"",enabled:!0,forward_metadata:!1,forward_thinking:!1,max_qps:0,operator_id:"",response_format:"",input_price:0,output_price:0}),S.value=!0},Y=n=>{R.value=!0,Object.assign(a,n),S.value=!0},Z=()=>{ee(),J.value.validate(async n=>{if(n)try{R.value?(await O.put(`/api/models/${encodeURIComponent(a.id)}`,a),I.success("更新成功")):(await O.post("/api/models",a),I.success("创建成功")),S.value=!1,await K()}catch{I.error("保存失败")}})},j=n=>{Ve.confirm(`确定要删除模型 ${n.id} 吗？`,"提示",{type:"warning"}).then(async()=>{try{await O.delete(`/api/models/${encodeURIComponent(n.id)}`),I.success("删除成功"),await K()}catch{I.error("删除失败")}}).catch(()=>{})},z=b(!1),D=b(!0),E=b(!1),w=b(null),A=b(""),V=b([]),N=fe(()=>{var n;return((n=w.value)==null?void 0:n.interface_type)||"openai"}),ee=()=>{(a.interface_type==="openai_responses"||a.response_format==="openai_responses"&&a.interface_type!=="openai_responses")&&(a.response_format="")},te=n=>{w.value=n,V.value=[{role:"assistant",content:`正在测试模型：${n.name||n.id}
接口类型：${n.interface_type||"(未设置)"}
上游模型：${n.upstream_id||"(未设置)"}
`}],A.value="",z.value=!0},le=n=>{if(!n)return;const e=V.value,s=e[e.length-1];if(!s||s.role!=="assistant"){e.push({role:"assistant",content:String(n)});return}s.content+=String(n)},ae=n=>{var e,s,d;if(!n)return null;if(n==="[DONE]")return{done:!0};try{const c=JSON.parse(n),v=(d=(s=(e=c==null?void 0:c.choices)==null?void 0:e[0])==null?void 0:s.delta)==null?void 0:d.content;if(typeof v=="string"&&v.length)return{delta:v}}catch{}return null},oe=n=>{var e;if(!n)return null;try{const s=JSON.parse(n);if((s==null?void 0:s.type)==="content_block_delta"&&((e=s==null?void 0:s.delta)!=null&&e.text))return{delta:s.delta.text}}catch{}return null},se=n=>{var e;if(!n)return null;try{const s=JSON.parse(n);if((s==null?void 0:s.type)==="content_delta"&&((e=s==null?void 0:s.delta)!=null&&e.text))return{delta:s.delta.text}}catch{}return null},ne=async n=>{var r;const e=localStorage.getItem("token")||"",s=await fetch("/back/api/chat/test",{method:"POST",headers:{"Content-Type":"application/json",token:e},body:JSON.stringify(n)});if(!s.ok||!s.body){const i=await s.text();throw new Error(i||`HTTP ${s.status}`)}const d=s.body.getReader(),c=new TextDecoder("utf-8");let v="";for(V.value.push({role:"assistant",content:""});;){const{value:i,done:u}=await d.read();if(u)break;v+=c.decode(i,{stream:!0});const C=v.split(/\r?\n/);v=C.pop()||"";for(const k of C){if(!k.startsWith("data:"))continue;const x=k.slice(5).trim();let y=null;if(N.value==="anthropic"?y=oe(x):N.value==="openai_responses"||((r=w.value)==null?void 0:r.response_format)==="openai_responses"?y=se(x):y=ae(x),y!=null&&y.done)return;y!=null&&y.delta&&le(y.delta)}}},F=async()=>{var s,d,c,v;if(!w.value||!A.value.trim()||E.value)return;E.value=!0;const n=A.value.trim();A.value="",V.value.push({role:"user",content:n});const e={model_id:w.value.id,stream:!!D.value,messages:V.value.filter(r=>r.role==="user"||r.role==="assistant").map(r=>({role:r.role,content:r.content}))};try{if(D.value){await ne(e);return}const{data:r}=await O.post("/api/chat/test",e);if(N.value==="anthropic"){const i=((r==null?void 0:r.content)||[]).filter(u=>(u==null?void 0:u.type)==="text").map(u=>(u==null?void 0:u.text)||"").join("");V.value.push({role:"assistant",content:i||JSON.stringify(r)})}else if(N.value==="openai_responses"){const i=((s=r==null?void 0:r.message)==null?void 0:s.content)||JSON.stringify(r);V.value.push({role:"assistant",content:i})}else{const i=(v=(c=(d=r==null?void 0:r.choices)==null?void 0:d[0])==null?void 0:c.message)==null?void 0:v.content;V.value.push({role:"assistant",content:i||JSON.stringify(r)})}}catch(r){I.error("发送失败"),V.value.push({role:"assistant",content:`请求失败：${(r==null?void 0:r.message)||r}`})}finally{E.value=!1}};return ce(()=>{K(),G()}),(n,e)=>{const s=_("el-button"),d=_("el-table-column"),c=_("el-tag"),v=_("el-table"),r=_("el-input"),i=_("el-form-item"),u=_("el-option"),C=_("el-select"),k=_("el-switch"),x=_("el-input-number"),y=_("el-form"),re=_("el-dialog"),ie=_("el-drawer"),de=ve("loading");return m(),g("div",he,[p("div",we,[e[22]||(e[22]=p("h2",{class:"text-xl font-semibold"},"模型管理",-1)),l(s,{type:"primary",onClick:X},{default:o(()=>e[21]||(e[21]=[f(" 新建模型 ")])),_:1})]),_e((m(),q(v,{data:T.value,border:"",style:{width:"100%"}},{default:o(()=>[l(d,{prop:"id",label:"ID",width:"220"}),l(d,{prop:"name",label:"名称",width:"180"}),l(d,{prop:"provider",label:"服务商",width:"140"}),l(d,{prop:"interface_type",label:"接口类型",width:"160"}),l(d,{prop:"response_format",label:"响应格式",width:"160"},{default:o(({row:t})=>[t.response_format==="openai_responses"?(m(),q(c,{key:0,type:"info",size:"small"},{default:o(()=>e[23]||(e[23]=[f(" OpenAI Responses ")])),_:1})):(m(),g("span",ke,"Anthropic（默认）"))]),_:1}),l(d,{prop:"base_url",label:"Base URL",width:"260"}),l(d,{prop:"api_key",label:"上游 API Key",width:"260"},{default:o(({row:t})=>[t.api_key?(m(),g("span",xe,"••••••••")):(m(),g("span",Ue,"未配置"))]),_:1}),l(d,{prop:"enabled",label:"启用",width:"80"},{default:o(({row:t})=>[l(c,{type:t.enabled?"success":"info"},{default:o(()=>[f(h(t.enabled?"启用":"停用"),1)]),_:2},1032,["type"])]),_:1}),l(d,{label:"扩展字段",width:"120"},{default:o(({row:t})=>[t.operator_id?(m(),g("span",Ie,"运营商")):(m(),g("span",Se,[t.forward_metadata?(m(),q(c,{key:0,size:"small",type:"info"},{default:o(()=>e[24]||(e[24]=[f("metadata")])),_:1})):$("",!0),t.forward_thinking?(m(),q(c,{key:1,size:"small",type:"info"},{default:o(()=>e[25]||(e[25]=[f("thinking")])),_:1})):$("",!0),!t.forward_metadata&&!t.forward_thinking?(m(),g("span",Ae,"—")):$("",!0)]))]),_:1}),l(d,{prop:"max_qps",label:"QPS",width:"80"},{default:o(({row:t})=>[f(h(t.max_qps>0?t.max_qps:"—"),1)]),_:1}),l(d,{prop:"input_price",label:"输入价格",width:"120"},{default:o(({row:t})=>[f(h(t.input_price||"—"),1)]),_:1}),l(d,{prop:"output_price",label:"输出价格",width:"120"},{default:o(({row:t})=>[f(h(t.output_price||"—"),1)]),_:1}),l(d,{prop:"operator_id",label:"运营商",width:"120"},{default:o(({row:t})=>[f(h(t.operator_id||"—"),1)]),_:1}),l(d,{prop:"description",label:"描述"}),l(d,{label:"操作",width:"260",fixed:"right"},{default:o(({row:t})=>[l(s,{size:"small",type:"primary",onClick:P=>te(t)},{default:o(()=>e[26]||(e[26]=[f("聊天测试")])),_:2},1032,["onClick"]),l(s,{size:"small",onClick:P=>Y(t)},{default:o(()=>e[27]||(e[27]=[f("编辑")])),_:2},1032,["onClick"]),l(s,{size:"small",type:"danger",onClick:P=>j(t)},{default:o(()=>e[28]||(e[28]=[f("删除")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[de,M.value]]),l(re,{modelValue:S.value,"onUpdate:modelValue":e[17]||(e[17]=t=>S.value=t),title:R.value?"编辑模型":"新建模型",width:"560px"},{footer:o(()=>[p("span",Oe,[l(s,{onClick:e[16]||(e[16]=t=>S.value=!1)},{default:o(()=>e[36]||(e[36]=[f("取 消")])),_:1}),l(s,{type:"primary",onClick:Z},{default:o(()=>e[37]||(e[37]=[f("确 定")])),_:1})])]),default:o(()=>[l(y,{ref_key:"formRef",ref:J,model:a,rules:W,"label-width":"100px"},{default:o(()=>[l(i,{label:"ID",prop:"id"},{default:o(()=>[l(r,{modelValue:a.id,"onUpdate:modelValue":e[0]||(e[0]=t=>a.id=t),disabled:R.value},null,8,["modelValue","disabled"])]),_:1}),l(i,{label:"名称",prop:"name"},{default:o(()=>[l(r,{modelValue:a.name,"onUpdate:modelValue":e[1]||(e[1]=t=>a.name=t)},null,8,["modelValue"])]),_:1}),l(i,{label:"服务商",prop:"provider"},{default:o(()=>[l(r,{modelValue:a.provider,"onUpdate:modelValue":e[2]||(e[2]=t=>a.provider=t),placeholder:"例如 openai / anthropic"},null,8,["modelValue"])]),_:1}),l(i,{label:"运营商"},{default:o(()=>[l(C,{modelValue:a.operator_id,"onUpdate:modelValue":e[3]||(e[3]=t=>a.operator_id=t),placeholder:"无（直连 OpenAI/Anthropic）",clearable:"",style:{width:"100%"}},{default:o(()=>[(m(!0),g(Q,null,H(B.value,t=>(m(),q(u,{key:t.id,label:t.name||t.id,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),e[29]||(e[29]=p("div",{class:"form-hint"},"选择后，该模型走运营商专属 API（Base URL / API Key 以运营商为准）",-1))]),_:1}),l(i,{label:"接口类型"},{default:o(()=>[l(C,{modelValue:a.interface_type,"onUpdate:modelValue":e[4]||(e[4]=t=>a.interface_type=t),placeholder:"选择接口类型",style:{width:"100%"}},{default:o(()=>[l(u,{label:"openai",value:"openai"}),l(u,{label:"openai_compatible",value:"openai_compatible"}),l(u,{label:"openai_responses(codex)",value:"openai_responses"}),l(u,{label:"anthropic(claude)",value:"anthropic"})]),_:1},8,["modelValue"]),a.operator_id?(m(),g("div",Ce,"归属运营商时可由运营商配置覆盖")):$("",!0)]),_:1}),l(i,{label:"响应格式"},{default:o(()=>[l(C,{modelValue:a.response_format,"onUpdate:modelValue":e[5]||(e[5]=t=>a.response_format=t),placeholder:"选择响应格式（默认 Anthropic）",clearable:"",style:{width:"100%"}},{default:o(()=>[l(u,{label:"Anthropic（默认）",value:""}),l(u,{label:"Anthropic",value:"anthropic"}),l(u,{label:"OpenAI Responses API",value:"openai_responses"})]),_:1},8,["modelValue"]),e[30]||(e[30]=p("div",{class:"form-hint"},"选 OpenAI Responses 接口时也默认为 Anthropic；若需 /back/v1/messages 返回 OpenAI Responses 格式，可在此选择「OpenAI Responses API」",-1))]),_:1}),l(i,{label:"上游模型名",prop:"upstream_id"},{default:o(()=>[l(r,{modelValue:a.upstream_id,"onUpdate:modelValue":e[6]||(e[6]=t=>a.upstream_id=t),placeholder:"例如 gpt-4.1 / claude-3-5-sonnet-20241022"},null,8,["modelValue"])]),_:1}),l(i,{label:"上游 API Key"},{default:o(()=>[l(r,{modelValue:a.api_key,"onUpdate:modelValue":e[7]||(e[7]=t=>a.api_key=t),type:"password","show-password":"",placeholder:a.operator_id?"归属运营商时使用运营商 API Key":"可选：为该模型配置专用上游 API Key"},null,8,["modelValue","placeholder"])]),_:1}),l(i,{label:"Base URL"},{default:o(()=>[l(r,{modelValue:a.base_url,"onUpdate:modelValue":e[8]||(e[8]=t=>a.base_url=t),placeholder:a.operator_id?"归属运营商时使用运营商 Base URL":"可选：为该模型覆盖 Provider 的 BaseURL"},null,8,["modelValue","placeholder"])]),_:1}),l(i,{label:"转发 metadata"},{default:o(()=>[l(k,{modelValue:a.forward_metadata,"onUpdate:modelValue":e[9]||(e[9]=t=>a.forward_metadata=t)},null,8,["modelValue"]),e[31]||(e[31]=p("span",{class:"form-hint-inline"},"部分上游（如 ModelScope）不支持则关闭",-1))]),_:1}),l(i,{label:"转发 thinking"},{default:o(()=>[l(k,{modelValue:a.forward_thinking,"onUpdate:modelValue":e[10]||(e[10]=t=>a.forward_thinking=t)},null,8,["modelValue"]),e[32]||(e[32]=p("span",{class:"form-hint-inline"},"扩展思考，不支持则关闭",-1))]),_:1}),l(i,{label:"最大 QPS"},{default:o(()=>[l(x,{modelValue:a.max_qps,"onUpdate:modelValue":e[11]||(e[11]=t=>a.max_qps=t),min:0,max:100,step:.5},null,8,["modelValue"]),e[33]||(e[33]=p("span",{class:"form-hint-inline"},"0 表示不限制",-1))]),_:1}),l(i,{label:"输入价格"},{default:o(()=>[l(x,{modelValue:a.input_price,"onUpdate:modelValue":e[12]||(e[12]=t=>a.input_price=t),min:0,step:1e-4},null,8,["modelValue"]),e[34]||(e[34]=p("span",{class:"form-hint-inline"},"单位：元/1K tokens",-1))]),_:1}),l(i,{label:"输出价格"},{default:o(()=>[l(x,{modelValue:a.output_price,"onUpdate:modelValue":e[13]||(e[13]=t=>a.output_price=t),min:0,step:1e-4},null,8,["modelValue"]),e[35]||(e[35]=p("span",{class:"form-hint-inline"},"单位：元/1K tokens",-1))]),_:1}),l(i,{label:"描述"},{default:o(()=>[l(r,{modelValue:a.description,"onUpdate:modelValue":e[14]||(e[14]=t=>a.description=t),type:"textarea",rows:3},null,8,["modelValue"])]),_:1}),l(i,{label:"启用"},{default:o(()=>[l(k,{modelValue:a.enabled,"onUpdate:modelValue":e[15]||(e[15]=t=>a.enabled=t)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(ie,{modelValue:z.value,"onUpdate:modelValue":e[20]||(e[20]=t=>z.value=t),size:"520px","with-header":!0,title:"聊天测试"},{default:o(()=>{var t,P,L;return[p("div",Re,[p("div",Pe,[p("div",qe,h(((t=w.value)==null?void 0:t.name)||((P=w.value)==null?void 0:P.id)),1),p("div",De,"接口类型："+h(((L=w.value)==null?void 0:L.interface_type)||"openai"),1)]),p("div",Ee,[l(k,{modelValue:D.value,"onUpdate:modelValue":e[18]||(e[18]=U=>D.value=U),"active-text":"SSE","inactive-text":"非流式"},null,8,["modelValue"])])]),p("div",Ne,[(m(!0),g(Q,null,H(V.value,(U,pe)=>(m(),g("div",{key:pe,class:ye(["chat-bubble",U.role==="user"?"from-user":"from-assistant"])},[p("div",$e,h(U.role),1),p("div",Me,h(U.content),1)],2))),128))]),p("div",Be,[l(r,{modelValue:A.value,"onUpdate:modelValue":e[19]||(e[19]=U=>A.value=U),type:"textarea",rows:3,placeholder:"输入一段内容测试模型...",onKeydown:be(ge(F,["exact","prevent"]),["enter"])},null,8,["modelValue","onKeydown"]),p("div",Ke,[l(s,{type:"primary",loading:E.value,onClick:F},{default:o(()=>e[38]||(e[38]=[f("发送")])),_:1},8,["loading"])])])]}),_:1},8,["modelValue"])])}}},Fe=ue(ze,[["__scopeId","data-v-e192c265"]]);export{Fe as default};
