import{_ as L,r,n as F,p as G,c as k,o as p,a as t,q as J,b as a,w as s,e as i,s as Q,j as b,g as w,E as c,f as m,t as d,v as W}from"./index-C8yXOZaD.js";const X={class:"p-6"},Z={class:"flex items-center justify-between mb-4"},h={key:0},ee={key:1,class:"text-gray-400"},le={class:"dialog-footer"},te={key:1,class:"usage-panel"},ae={class:"usage-row"},se={class:"usage-row"},oe={class:"usage-row"},ne={class:"usage-row"},ie={class:"usage-row"},ue={class:"usage-row"},de={class:"usage-row"},re={__name:"UsersView",setup(pe){const V=r(!1),C=r([]),x=r(!1),q=r(!1),u=r(null),f=r(!1),v=r(!1),U=r(),o=F({username:"",api_key:"",quota:-1,expire_at:"",is_admin:!1}),E={username:[{required:!0,message:"请输入用户名",trigger:"blur"}]},D=async()=>{V.value=!0;try{const{data:n}=await w.get("/api/users");C.value=n||[]}catch{c.error("加载用户列表失败")}finally{V.value=!1}},N=()=>{v.value=!1,Object.assign(o,{username:"",api_key:"",quota:-1,expire_at:"",is_admin:!1}),f.value=!0},$=n=>{v.value=!0,Object.assign(o,{username:n.username,api_key:n.api_key,quota:n.quota,expire_at:n.expire_at?n.expire_at.slice(0,19):"",is_admin:!!n.is_admin}),f.value=!0},j=()=>{U.value.validate(async n=>{if(!n)return;const e={quota:Number(o.quota),is_admin:!!o.is_admin};o.expire_at&&(e.expire_at=new Date(o.expire_at).toISOString());try{v.value?(await w.put(`/api/users/${encodeURIComponent(o.username)}`,{...e,api_key:o.api_key}),c.success("更新用户成功")):(await w.post("/api/users",{username:o.username,...e}),c.success("创建用户成功（API Key 已自动生成）")),f.value=!1,await D()}catch{c.error("保存用户失败")}})},A=async n=>{x.value=!0,q.value=!0;try{const{data:e}=await w.get(`/api/users/${encodeURIComponent(n.username)}/usage`);u.value=e}catch{u.value=null,c.error("加载使用情况失败")}finally{x.value=!1}};return G(D),(n,e)=>{const g=i("el-button"),_=i("el-table-column"),B=i("el-tag"),K=i("el-table"),I=i("el-input"),y=i("el-form-item"),M=i("el-alert"),P=i("el-input-number"),R=i("el-date-picker"),Y=i("el-switch"),O=i("el-form"),T=i("el-dialog"),S=i("el-skeleton"),z=Q("loading");return p(),k("div",X,[t("div",Z,[e[9]||(e[9]=t("h2",{class:"text-xl font-semibold"},"用户管理",-1)),a(g,{type:"primary",onClick:N},{default:s(()=>e[8]||(e[8]=[m("新增用户")])),_:1})]),J((p(),b(K,{data:C.value,border:"",style:{width:"100%"}},{default:s(()=>[a(_,{prop:"username",label:"用户名",width:"180"}),a(_,{prop:"api_key",label:"API Key",width:"240"},{default:s(({row:l})=>[l.api_key?(p(),k("span",h,"••••••••")):(p(),k("span",ee,"未设置"))]),_:1}),a(_,{prop:"quota",label:"额度",width:"120"},{default:s(({row:l})=>[m(d(l.quota<0?"无限":l.quota),1)]),_:1}),a(_,{prop:"expire_at",label:"过期时间",width:"220"},{default:s(({row:l})=>[m(d(l.expire_at||"不过期"),1)]),_:1}),a(_,{prop:"is_admin",label:"管理员",width:"120"},{default:s(({row:l})=>[a(B,{type:l.is_admin?"danger":"info"},{default:s(()=>[m(d(l.is_admin?"是":"否"),1)]),_:2},1032,["type"])]),_:1}),a(_,{prop:"total_tokens",label:"总 Token",width:"140"}),a(_,{label:"操作",width:"220",fixed:"right"},{default:s(({row:l})=>[a(g,{size:"small",onClick:H=>$(l)},{default:s(()=>e[10]||(e[10]=[m("编辑")])),_:2},1032,["onClick"]),a(g,{size:"small",type:"primary",onClick:H=>A(l)},{default:s(()=>e[11]||(e[11]=[m("使用情况")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[z,V.value]]),a(T,{modelValue:f.value,"onUpdate:modelValue":e[6]||(e[6]=l=>f.value=l),title:v.value?"编辑用户":"新增用户",width:"560px"},{footer:s(()=>[t("span",le,[a(g,{onClick:e[5]||(e[5]=l=>f.value=!1)},{default:s(()=>e[13]||(e[13]=[m("取消")])),_:1}),a(g,{type:"primary",onClick:j},{default:s(()=>e[14]||(e[14]=[m("确定")])),_:1})])]),default:s(()=>[a(O,{ref_key:"formRef",ref:U,model:o,rules:E,"label-width":"100px"},{default:s(()=>[a(y,{label:"用户名",prop:"username"},{default:s(()=>[a(I,{modelValue:o.username,"onUpdate:modelValue":e[0]||(e[0]=l=>o.username=l),disabled:v.value},null,8,["modelValue","disabled"])]),_:1}),v.value?(p(),b(y,{key:0,label:"API Key",prop:"api_key"},{default:s(()=>[a(I,{modelValue:o.api_key,"onUpdate:modelValue":e[1]||(e[1]=l=>o.api_key=l),"show-password":""},null,8,["modelValue"])]),_:1})):(p(),b(M,{key:1,title:"创建用户时 API Key 由系统自动生成（32位字母数字）",type:"info",closable:!1,"show-icon":"",class:"mb-3"})),a(y,{label:"额度"},{default:s(()=>[a(P,{modelValue:o.quota,"onUpdate:modelValue":e[2]||(e[2]=l=>o.quota=l),min:-1,step:1e3},null,8,["modelValue"]),e[12]||(e[12]=t("span",{class:"form-hint-inline"},"-1 表示无限",-1))]),_:1}),a(y,{label:"过期时间"},{default:s(()=>[a(R,{modelValue:o.expire_at,"onUpdate:modelValue":e[3]||(e[3]=l=>o.expire_at=l),type:"datetime","value-format":"YYYY-MM-DDTHH:mm:ss",placeholder:"可选，不填表示不过期",style:{width:"100%"},clearable:""},null,8,["modelValue"])]),_:1}),a(y,{label:"管理员"},{default:s(()=>[a(Y,{modelValue:o.is_admin,"onUpdate:modelValue":e[4]||(e[4]=l=>o.is_admin=l)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),a(T,{modelValue:q.value,"onUpdate:modelValue":e[7]||(e[7]=l=>q.value=l),title:"用户使用情况",width:"520px"},{default:s(()=>[x.value?(p(),b(S,{key:0,rows:6,animated:""})):u.value?(p(),k("div",te,[t("div",ae,[e[15]||(e[15]=t("span",null,"用户名",-1)),t("strong",null,d(u.value.username),1)]),t("div",se,[e[16]||(e[16]=t("span",null,"输入 Token",-1)),t("strong",null,d(u.value.input_tokens),1)]),t("div",oe,[e[17]||(e[17]=t("span",null,"输出 Token",-1)),t("strong",null,d(u.value.output_tokens),1)]),t("div",ne,[e[18]||(e[18]=t("span",null,"总 Token",-1)),t("strong",null,d(u.value.total_tokens),1)]),t("div",ie,[e[19]||(e[19]=t("span",null,"额度",-1)),t("strong",null,d(u.value.unlimited?"无限":u.value.quota),1)]),t("div",ue,[e[20]||(e[20]=t("span",null,"剩余额度",-1)),t("strong",null,d(u.value.unlimited?"无限":u.value.remaining),1)]),t("div",de,[e[21]||(e[21]=t("span",null,"过期时间",-1)),t("strong",null,d(u.value.expire_at||"不过期"),1)])])):W("",!0)]),_:1},8,["modelValue"])])}}},_e=L(re,[["__scopeId","data-v-fad4e65d"]]);export{_e as default};
