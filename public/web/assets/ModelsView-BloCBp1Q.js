import{_ as de,r as _,h as ue,i as pe,j as me,c as b,o as m,a as u,k as ce,b as l,w as o,f,l as fe,m as D,g as I,E as x,d as v,t as U,n as E,F,p as j,q as _e,s as ve,e as ye,v as be}from"./index-Dab5jV9r.js";const ge={class:"p-6"},he={class:"flex items-center justify-between mb-4"},Ve={key:0},we={key:1,class:"text-gray-400"},ke={key:0,class:"text-gray-400"},xe={key:1},Ue={key:2},Ce={key:0,class:"form-hint"},Se={class:"dialog-footer"},Ie={class:"chat-toolbar"},Ae={class:"chat-meta"},Oe={class:"chat-meta-title"},qe={class:"chat-meta-sub"},Me={class:"chat-actions"},$e={class:"chat-messages"},De={class:"chat-role"},Ee={class:"chat-content"},Pe={class:"chat-input"},Re={class:"chat-send"},Be={__name:"ModelsView",setup(Ne){const P=_(!1),K=_([]),R=_([]),C=_(!1),A=_(!1),s=ue({id:"",name:"",provider:"",interface_type:"",upstream_id:"",api_key:"",base_url:"",description:"",enabled:!0,forward_metadata:!1,forward_thinking:!1,max_qps:0,operator_id:""}),Q={id:[{required:!0,message:"请输入模型 ID",trigger:"blur"}],name:[{required:!0,message:"请输入名称",trigger:"blur"}],provider:[{required:!0,message:"请输入服务商标识（如 openai / anthropic）",trigger:"blur"}],upstream_id:[{required:!0,message:"请输入上游模型名",trigger:"blur"}]},z=_(),B=async()=>{P.value=!0;try{const{data:a}=await I.get("/api/models");K.value=a||[]}catch{x.error("加载模型列表失败")}finally{P.value=!1}},H=async()=>{try{const{data:a}=await I.get("/api/operators");R.value=a||[]}catch{R.value=[]}},W=()=>{A.value=!1,Object.assign(s,{id:"",name:"",provider:"",interface_type:"openai",upstream_id:"",api_key:"",base_url:"",description:"",enabled:!0,forward_metadata:!1,forward_thinking:!1,max_qps:0,operator_id:""}),C.value=!0},G=a=>{A.value=!0,Object.assign(s,a),C.value=!0},X=()=>{z.value.validate(async a=>{if(a)try{A.value?(await I.put(`/api/models/${encodeURIComponent(s.id)}`,s),x.success("更新成功")):(await I.post("/api/models",s),x.success("创建成功")),C.value=!1,await B()}catch{x.error("保存失败")}})},Y=a=>{be.confirm(`确定要删除模型 ${a.id} 吗？`,"提示",{type:"warning"}).then(async()=>{try{await I.delete(`/api/models/${encodeURIComponent(a.id)}`),x.success("删除成功"),await B()}catch{x.error("删除失败")}}).catch(()=>{})},N=_(!1),M=_(!0),$=_(!1),h=_(null),S=_(""),g=_([]),T=pe(()=>{var a;return((a=h.value)==null?void 0:a.interface_type)||"openai"}),Z=a=>{h.value=a,g.value=[{role:"assistant",content:`正在测试模型：${a.name||a.id}
接口类型：${a.interface_type||"(未设置)"}
上游模型：${a.upstream_id||"(未设置)"}
`}],S.value="",N.value=!0},ee=a=>{if(!a)return;const e=g.value,n=e[e.length-1];if(!n||n.role!=="assistant"){e.push({role:"assistant",content:String(a)});return}n.content+=String(a)},te=a=>{var e,n,d;if(!a)return null;if(a==="[DONE]")return{done:!0};try{const c=JSON.parse(a),r=(d=(n=(e=c==null?void 0:c.choices)==null?void 0:e[0])==null?void 0:n.delta)==null?void 0:d.content;if(typeof r=="string"&&r.length)return{delta:r}}catch{}return null},le=a=>{var e;if(!a)return null;try{const n=JSON.parse(a);if((n==null?void 0:n.type)==="content_block_delta"&&((e=n==null?void 0:n.delta)!=null&&e.text))return{delta:n.delta.text}}catch{}return null},ae=async a=>{const e=localStorage.getItem("token")||"",n=await fetch("/back/api/chat/test",{method:"POST",headers:{"Content-Type":"application/json",token:e},body:JSON.stringify(a)});if(!n.ok||!n.body){const p=await n.text();throw new Error(p||`HTTP ${n.status}`)}const d=n.body.getReader(),c=new TextDecoder("utf-8");let r="";for(g.value.push({role:"assistant",content:""});;){const{value:p,done:i}=await d.read();if(i)break;r+=c.decode(p,{stream:!0});const V=r.split(/\r?\n/);r=V.pop()||"";for(const O of V){if(!O.startsWith("data:"))continue;const w=O.slice(5).trim();let y=null;if(T.value==="anthropic"?y=le(w):y=te(w),y!=null&&y.done)return;y!=null&&y.delta&&ee(y.delta)}}},J=async()=>{var n,d,c;if(!h.value||!S.value.trim()||$.value)return;$.value=!0;const a=S.value.trim();S.value="",g.value.push({role:"user",content:a});const e={model_id:h.value.id,stream:!!M.value,messages:g.value.filter(r=>r.role==="user"||r.role==="assistant").map(r=>({role:r.role,content:r.content}))};try{if(M.value){await ae(e);return}const{data:r}=await I.post("/api/chat/test",e);if(T.value==="anthropic"){const p=((r==null?void 0:r.content)||[]).filter(i=>(i==null?void 0:i.type)==="text").map(i=>(i==null?void 0:i.text)||"").join("");g.value.push({role:"assistant",content:p||JSON.stringify(r)})}else{const p=(c=(d=(n=r==null?void 0:r.choices)==null?void 0:n[0])==null?void 0:d.message)==null?void 0:c.content;g.value.push({role:"assistant",content:p||JSON.stringify(r)})}}catch(r){x.error("发送失败"),g.value.push({role:"assistant",content:`请求失败：${(r==null?void 0:r.message)||r}`})}finally{$.value=!1}};return me(()=>{B(),H()}),(a,e)=>{const n=f("el-button"),d=f("el-table-column"),c=f("el-tag"),r=f("el-table"),p=f("el-input"),i=f("el-form-item"),V=f("el-option"),O=f("el-select"),w=f("el-switch"),y=f("el-input-number"),oe=f("el-form"),se=f("el-dialog"),ne=f("el-drawer"),re=fe("loading");return m(),b("div",ge,[u("div",he,[e[19]||(e[19]=u("h2",{class:"text-xl font-semibold"},"模型管理",-1)),l(n,{type:"primary",onClick:W},{default:o(()=>e[18]||(e[18]=[v(" 新建模型 ")])),_:1})]),ce((m(),D(r,{data:K.value,border:"",style:{width:"100%"}},{default:o(()=>[l(d,{prop:"id",label:"ID",width:"220"}),l(d,{prop:"name",label:"名称",width:"180"}),l(d,{prop:"provider",label:"服务商",width:"140"}),l(d,{prop:"interface_type",label:"接口类型",width:"160"}),l(d,{prop:"upstream_id",label:"上游模型名",width:"220"}),l(d,{prop:"base_url",label:"Base URL",width:"260"}),l(d,{prop:"api_key",label:"上游 API Key",width:"260"},{default:o(({row:t})=>[t.api_key?(m(),b("span",Ve,"••••••••")):(m(),b("span",we,"未配置"))]),_:1}),l(d,{prop:"enabled",label:"启用",width:"80"},{default:o(({row:t})=>[l(c,{type:t.enabled?"success":"info"},{default:o(()=>[v(U(t.enabled?"启用":"停用"),1)]),_:2},1032,["type"])]),_:1}),l(d,{label:"扩展字段",width:"120"},{default:o(({row:t})=>[t.operator_id?(m(),b("span",ke,"运营商")):(m(),b("span",xe,[t.forward_metadata?(m(),D(c,{key:0,size:"small",type:"info"},{default:o(()=>e[20]||(e[20]=[v("metadata")])),_:1})):E("",!0),t.forward_thinking?(m(),D(c,{key:1,size:"small",type:"info"},{default:o(()=>e[21]||(e[21]=[v("thinking")])),_:1})):E("",!0),!t.forward_metadata&&!t.forward_thinking?(m(),b("span",Ue,"—")):E("",!0)]))]),_:1}),l(d,{prop:"max_qps",label:"QPS",width:"80"},{default:o(({row:t})=>[v(U(t.max_qps>0?t.max_qps:"—"),1)]),_:1}),l(d,{prop:"operator_id",label:"运营商",width:"120"},{default:o(({row:t})=>[v(U(t.operator_id||"—"),1)]),_:1}),l(d,{prop:"description",label:"描述"}),l(d,{label:"操作",width:"260",fixed:"right"},{default:o(({row:t})=>[l(n,{size:"small",type:"primary",onClick:q=>Z(t)},{default:o(()=>e[22]||(e[22]=[v("聊天测试")])),_:2},1032,["onClick"]),l(n,{size:"small",onClick:q=>G(t)},{default:o(()=>e[23]||(e[23]=[v("编辑")])),_:2},1032,["onClick"]),l(n,{size:"small",type:"danger",onClick:q=>Y(t)},{default:o(()=>e[24]||(e[24]=[v("删除")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[re,P.value]]),l(se,{modelValue:C.value,"onUpdate:modelValue":e[14]||(e[14]=t=>C.value=t),title:A.value?"编辑模型":"新建模型",width:"560px"},{footer:o(()=>[u("span",Se,[l(n,{onClick:e[13]||(e[13]=t=>C.value=!1)},{default:o(()=>e[29]||(e[29]=[v("取 消")])),_:1}),l(n,{type:"primary",onClick:X},{default:o(()=>e[30]||(e[30]=[v("确 定")])),_:1})])]),default:o(()=>[l(oe,{ref_key:"formRef",ref:z,model:s,rules:Q,"label-width":"100px"},{default:o(()=>[l(i,{label:"ID",prop:"id"},{default:o(()=>[l(p,{modelValue:s.id,"onUpdate:modelValue":e[0]||(e[0]=t=>s.id=t),disabled:A.value},null,8,["modelValue","disabled"])]),_:1}),l(i,{label:"名称",prop:"name"},{default:o(()=>[l(p,{modelValue:s.name,"onUpdate:modelValue":e[1]||(e[1]=t=>s.name=t)},null,8,["modelValue"])]),_:1}),l(i,{label:"服务商",prop:"provider"},{default:o(()=>[l(p,{modelValue:s.provider,"onUpdate:modelValue":e[2]||(e[2]=t=>s.provider=t),placeholder:"例如 openai / anthropic"},null,8,["modelValue"])]),_:1}),l(i,{label:"运营商"},{default:o(()=>[l(O,{modelValue:s.operator_id,"onUpdate:modelValue":e[3]||(e[3]=t=>s.operator_id=t),placeholder:"无（直连 OpenAI/Anthropic）",clearable:"",style:{width:"100%"}},{default:o(()=>[(m(!0),b(F,null,j(R.value,t=>(m(),D(V,{key:t.id,label:t.name||t.id,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),e[25]||(e[25]=u("div",{class:"form-hint"},"选择后，该模型走运营商专属 API（Base URL / API Key 以运营商为准）",-1))]),_:1}),l(i,{label:"接口类型"},{default:o(()=>[l(O,{modelValue:s.interface_type,"onUpdate:modelValue":e[4]||(e[4]=t=>s.interface_type=t),placeholder:"选择接口类型",style:{width:"100%"}},{default:o(()=>[l(V,{label:"OpenAI Chat Completions",value:"openai"}),l(V,{label:"OpenAI 兼容",value:"openai_compatible"}),l(V,{label:"Anthropic Messages",value:"anthropic"})]),_:1},8,["modelValue"]),s.operator_id?(m(),b("div",Ce,"归属运营商时可由运营商配置覆盖")):E("",!0)]),_:1}),l(i,{label:"上游模型名",prop:"upstream_id"},{default:o(()=>[l(p,{modelValue:s.upstream_id,"onUpdate:modelValue":e[5]||(e[5]=t=>s.upstream_id=t),placeholder:"例如 gpt-4.1 / claude-3-5-sonnet-20241022"},null,8,["modelValue"])]),_:1}),l(i,{label:"上游 API Key"},{default:o(()=>[l(p,{modelValue:s.api_key,"onUpdate:modelValue":e[6]||(e[6]=t=>s.api_key=t),type:"password","show-password":"",placeholder:s.operator_id?"归属运营商时使用运营商 API Key":"可选：为该模型配置专用上游 API Key"},null,8,["modelValue","placeholder"])]),_:1}),l(i,{label:"Base URL"},{default:o(()=>[l(p,{modelValue:s.base_url,"onUpdate:modelValue":e[7]||(e[7]=t=>s.base_url=t),placeholder:s.operator_id?"归属运营商时使用运营商 Base URL":"可选：为该模型覆盖 Provider 的 BaseURL"},null,8,["modelValue","placeholder"])]),_:1}),l(i,{label:"转发 metadata"},{default:o(()=>[l(w,{modelValue:s.forward_metadata,"onUpdate:modelValue":e[8]||(e[8]=t=>s.forward_metadata=t)},null,8,["modelValue"]),e[26]||(e[26]=u("span",{class:"form-hint-inline"},"部分上游（如 ModelScope）不支持则关闭",-1))]),_:1}),l(i,{label:"转发 thinking"},{default:o(()=>[l(w,{modelValue:s.forward_thinking,"onUpdate:modelValue":e[9]||(e[9]=t=>s.forward_thinking=t)},null,8,["modelValue"]),e[27]||(e[27]=u("span",{class:"form-hint-inline"},"扩展思考，不支持则关闭",-1))]),_:1}),l(i,{label:"最大 QPS"},{default:o(()=>[l(y,{modelValue:s.max_qps,"onUpdate:modelValue":e[10]||(e[10]=t=>s.max_qps=t),min:0,max:100,step:.5},null,8,["modelValue"]),e[28]||(e[28]=u("span",{class:"form-hint-inline"},"0 表示不限制",-1))]),_:1}),l(i,{label:"描述"},{default:o(()=>[l(p,{modelValue:s.description,"onUpdate:modelValue":e[11]||(e[11]=t=>s.description=t),type:"textarea",rows:3},null,8,["modelValue"])]),_:1}),l(i,{label:"启用"},{default:o(()=>[l(w,{modelValue:s.enabled,"onUpdate:modelValue":e[12]||(e[12]=t=>s.enabled=t)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(ne,{modelValue:N.value,"onUpdate:modelValue":e[17]||(e[17]=t=>N.value=t),size:"520px","with-header":!0,title:"聊天测试"},{default:o(()=>{var t,q,L;return[u("div",Ie,[u("div",Ae,[u("div",Oe,U(((t=h.value)==null?void 0:t.name)||((q=h.value)==null?void 0:q.id)),1),u("div",qe,"接口类型："+U(((L=h.value)==null?void 0:L.interface_type)||"openai"),1)]),u("div",Me,[l(w,{modelValue:M.value,"onUpdate:modelValue":e[15]||(e[15]=k=>M.value=k),"active-text":"SSE","inactive-text":"非流式"},null,8,["modelValue"])])]),u("div",$e,[(m(!0),b(F,null,j(g.value,(k,ie)=>(m(),b("div",{key:ie,class:_e(["chat-bubble",k.role==="user"?"from-user":"from-assistant"])},[u("div",De,U(k.role),1),u("div",Ee,U(k.content),1)],2))),128))]),u("div",Pe,[l(p,{modelValue:S.value,"onUpdate:modelValue":e[16]||(e[16]=k=>S.value=k),type:"textarea",rows:3,placeholder:"输入一段内容测试模型...",onKeydown:ve(ye(J,["exact","prevent"]),["enter"])},null,8,["modelValue","onKeydown"]),u("div",Re,[l(n,{type:"primary",loading:$.value,onClick:J},{default:o(()=>e[31]||(e[31]=[v("发送")])),_:1},8,["loading"])])])]}),_:1},8,["modelValue"])])}}},ze=de(Be,[["__scopeId","data-v-56898b5c"]]);export{ze as default};
