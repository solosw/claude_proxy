import{_ as oe,r as c,n as h,p as ne,c as k,o as r,a as o,q as ie,b as a,w as t,e as u,s as ue,j as w,g as q,E as v,f as m,t as _,F,l as K,v as B,m as re}from"./index-BbdJjvGl.js";const de={class:"p-6"},me={class:"flex items-center justify-between mb-4"},pe={class:"filter-panel mb-4"},_e={class:"api-key-cell"},fe={class:"api-key-text"},ce={key:0,class:"text-gray-400 text-xs"},ve={key:1,class:"combo-tags"},be={key:0,class:"form-hint-inline"},ye={class:"dialog-footer"},ge={key:1,class:"usage-panel"},ke={class:"usage-row"},we={class:"usage-row"},Ve={class:"usage-row"},xe={class:"usage-row"},Ce={class:"usage-row"},Ue={class:"usage-row"},qe={class:"usage-row"},$e={__name:"UsersView",setup(Ie){const $=c(!1),A=c([]),D=c([]),I=c(!1),T=c(!1),p=c(null),V=c(!1),g=c(!1),M=c(),n=h({username:"",api_key:"",quota:-1,expire_at:"",is_admin:!1,allowed_combos:[]}),P={},f=h({username:"",is_admin:""}),x=async()=>{$.value=!0;try{const s={};f.username&&(s.username=f.username),f.is_admin!==""&&(s.is_admin=f.is_admin);const{data:e}=await q.get("/api/users",{params:s});A.value=e||[]}catch{v.error("加载用户列表失败")}finally{$.value=!1}},Y=async()=>{try{const{data:s}=await q.get("/api/combos");D.value=(s||[]).filter(e=>e.enabled)}catch{}},L=()=>{g.value=!1,Object.assign(n,{username:"",api_key:"",quota:-1,expire_at:"",is_admin:!1,allowed_combos:[]}),V.value=!0},O=()=>{const s="abcdefghijklmnopqrstuvwxyz0123456789";let e="";for(let i=0;i<8;i++)e+=s.charAt(Math.floor(Math.random()*s.length));n.username="user_"+e},S=s=>{g.value=!0;const e=s.allowed_combos?s.allowed_combos.split(",").map(i=>i.trim()).filter(Boolean):[];Object.assign(n,{username:s.username,api_key:s.api_key,quota:s.quota,expire_at:s.expire_at?s.expire_at.slice(0,19):"",is_admin:!!s.is_admin,allowed_combos:e}),V.value=!0},H=()=>{M.value.validate(async s=>{var i,C,d;if(!s)return;const e={quota:Number(n.quota),is_admin:!!n.is_admin,allowed_combos:Array.isArray(n.allowed_combos)?n.allowed_combos.join(","):""};n.expire_at&&typeof n.expire_at=="string"&&n.expire_at.trim()!==""&&(e.expire_at=new Date(n.expire_at).toISOString());try{g.value?(await q.put(`/api/users/${encodeURIComponent(n.username)}`,e),v.success("更新用户成功")):(await q.post("/api/users",{username:n.username,...e}),v.success("创建用户成功（API Key 已自动生成）")),V.value=!1,await x()}catch(b){console.error("保存用户失败:",((i=b.response)==null?void 0:i.data)||b.message),v.error(`保存用户失败: ${((d=(C=b.response)==null?void 0:C.data)==null?void 0:d.error)||b.message}`)}})},G=async s=>{I.value=!0,T.value=!0;try{const{data:e}=await q.get(`/api/users/${encodeURIComponent(s.username)}/usage`);p.value=e}catch{p.value=null,v.error("加载使用情况失败")}finally{I.value=!1}},J=s=>{re.confirm(`确定要删除用户 "${s.username}" 吗？此操作不可撤销。`,"删除用户",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await q.delete(`/api/users/${encodeURIComponent(s.username)}`),v.success("用户已删除"),await x()}catch{v.error("删除用户失败")}}).catch(()=>{})},Q=()=>{f.username="",f.is_admin="",x()},W=s=>{navigator.clipboard.writeText(s).then(()=>{v.success("已复制到剪贴板")}).catch(()=>{v.error("复制失败")})},j=s=>s.allowed_combos?s.allowed_combos.split(",").map(e=>e.trim()).filter(Boolean):[];return ne(()=>{x(),Y()}),(s,e)=>{const i=u("el-button"),C=u("el-input"),d=u("el-form-item"),b=u("el-option"),z=u("el-select"),E=u("el-form"),y=u("el-table-column"),N=u("el-tag"),X=u("el-table"),Z=u("el-alert"),ee=u("el-input-number"),le=u("el-date-picker"),ae=u("el-switch"),R=u("el-dialog"),te=u("el-skeleton"),se=ue("loading");return r(),k("div",de,[o("div",me,[e[12]||(e[12]=o("h2",{class:"text-xl font-semibold"},"用户管理",-1)),a(i,{type:"primary",onClick:L},{default:t(()=>e[11]||(e[11]=[m("新增用户")])),_:1})]),o("div",pe,[a(E,{model:f,layout:"inline",class:"filter-form"},{default:t(()=>[a(d,{label:"用户名"},{default:t(()=>[a(C,{modelValue:f.username,"onUpdate:modelValue":e[0]||(e[0]=l=>f.username=l),placeholder:"搜索用户名",clearable:"",onInput:x},null,8,["modelValue"])]),_:1}),a(d,{label:"管理员"},{default:t(()=>[a(z,{modelValue:f.is_admin,"onUpdate:modelValue":e[1]||(e[1]=l=>f.is_admin=l),placeholder:"全部",clearable:"",onChange:x},{default:t(()=>[a(b,{label:"是",value:"true"}),a(b,{label:"否",value:"false"})]),_:1},8,["modelValue"])]),_:1}),a(d,null,{default:t(()=>[a(i,{onClick:Q},{default:t(()=>e[13]||(e[13]=[m("重置")])),_:1})]),_:1})]),_:1},8,["model"])]),ie((r(),w(X,{data:A.value,border:"",style:{width:"100%"}},{default:t(()=>[a(y,{prop:"username",label:"用户名",width:"160"}),a(y,{prop:"api_key",label:"API Key",width:"260"},{default:t(({row:l})=>[o("div",_e,[o("span",fe,_(l.api_key),1),a(i,{link:"",type:"primary",size:"small",onClick:U=>W(l.api_key)},{default:t(()=>e[14]||(e[14]=[m(" 复制 ")])),_:2},1032,["onClick"])])]),_:1}),a(y,{prop:"quota",label:"额度",width:"100"},{default:t(({row:l})=>[m(_(l.quota<0?"无限":l.quota),1)]),_:1}),a(y,{prop:"expire_at",label:"过期时间",width:"180"},{default:t(({row:l})=>[m(_(l.expire_at||"不过期"),1)]),_:1}),a(y,{prop:"is_admin",label:"管理员",width:"90"},{default:t(({row:l})=>[a(N,{type:l.is_admin?"danger":"info"},{default:t(()=>[m(_(l.is_admin?"是":"否"),1)]),_:2},1032,["type"])]),_:1}),a(y,{label:"可用 Combo","min-width":"180"},{default:t(({row:l})=>[j(l).length?(r(),k("div",ve,[(r(!0),k(F,null,K(j(l),U=>(r(),w(N,{key:U,size:"small",type:"success",class:"mr-1 mb-1"},{default:t(()=>[m(_(U),1)]),_:2},1024))),128))])):(r(),k("span",ce,"不限制"))]),_:1}),a(y,{prop:"total_tokens",label:"总 Token",width:"120"}),a(y,{label:"操作",width:"240",fixed:"right"},{default:t(({row:l})=>[a(i,{size:"small",onClick:U=>S(l)},{default:t(()=>e[15]||(e[15]=[m("编辑")])),_:2},1032,["onClick"]),a(i,{size:"small",type:"primary",onClick:U=>G(l)},{default:t(()=>e[16]||(e[16]=[m("使用情况")])),_:2},1032,["onClick"]),a(i,{size:"small",type:"danger",onClick:U=>J(l)},{default:t(()=>e[17]||(e[17]=[m("删除")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[se,$.value]]),a(R,{modelValue:V.value,"onUpdate:modelValue":e[9]||(e[9]=l=>V.value=l),title:g.value?"编辑用户":"新增用户",width:"580px"},{footer:t(()=>[o("span",ye,[a(i,{onClick:e[8]||(e[8]=l=>V.value=!1)},{default:t(()=>e[21]||(e[21]=[m("取消")])),_:1}),a(i,{type:"primary",onClick:H},{default:t(()=>e[22]||(e[22]=[m("确定")])),_:1})])]),default:t(()=>[a(E,{ref_key:"formRef",ref:M,model:n,rules:P,"label-width":"110px"},{default:t(()=>[a(d,{label:"用户名",prop:"username"},{default:t(()=>[a(C,{modelValue:n.username,"onUpdate:modelValue":e[2]||(e[2]=l=>n.username=l),disabled:!0},null,8,["modelValue"]),g.value?B("",!0):(r(),k("span",be,"系统自动生成"))]),_:1}),g.value?B("",!0):(r(),w(d,{key:0},{default:t(()=>[a(i,{onClick:O},{default:t(()=>e[18]||(e[18]=[m("生成用户名")])),_:1})]),_:1})),g.value?(r(),w(d,{key:1,label:"API Key",prop:"api_key"},{default:t(()=>[a(C,{modelValue:n.api_key,"onUpdate:modelValue":e[3]||(e[3]=l=>n.api_key=l),"show-password":"",disabled:""},null,8,["modelValue"])]),_:1})):(r(),w(Z,{key:2,title:"创建用户时用户名和 API Key 由系统自动生成",type:"info",closable:!1,"show-icon":"",class:"mb-3"})),a(d,{label:"额度"},{default:t(()=>[a(ee,{modelValue:n.quota,"onUpdate:modelValue":e[4]||(e[4]=l=>n.quota=l),min:-1,step:1e3},null,8,["modelValue"]),e[19]||(e[19]=o("span",{class:"form-hint-inline"},"-1 表示无限",-1))]),_:1}),a(d,{label:"过期时间"},{default:t(()=>[a(le,{modelValue:n.expire_at,"onUpdate:modelValue":e[5]||(e[5]=l=>n.expire_at=l),type:"datetime","value-format":"YYYY-MM-DDTHH:mm:ss",placeholder:"可选，不填表示不过期",style:{width:"100%"},clearable:""},null,8,["modelValue"])]),_:1}),a(d,{label:"管理员"},{default:t(()=>[a(ae,{modelValue:n.is_admin,"onUpdate:modelValue":e[6]||(e[6]=l=>n.is_admin=l)},null,8,["modelValue"])]),_:1}),a(d,{label:"可用 Combo"},{default:t(()=>[a(z,{modelValue:n.allowed_combos,"onUpdate:modelValue":e[7]||(e[7]=l=>n.allowed_combos=l),multiple:"",clearable:"",placeholder:"不选表示不限制，可使用任意模型",style:{width:"100%"}},{default:t(()=>[(r(!0),k(F,null,K(D.value,l=>(r(),w(b,{key:l.id,label:l.name?`${l.name} (${l.id})`:l.id,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),e[20]||(e[20]=o("div",{class:"form-hint-block"},"不选表示不限制，可使用任意 Combo 模型",-1))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),a(R,{modelValue:T.value,"onUpdate:modelValue":e[10]||(e[10]=l=>T.value=l),title:"用户使用情况",width:"520px"},{default:t(()=>[I.value?(r(),w(te,{key:0,rows:6,animated:""})):p.value?(r(),k("div",ge,[o("div",ke,[e[23]||(e[23]=o("span",null,"用户名",-1)),o("strong",null,_(p.value.username),1)]),o("div",we,[e[24]||(e[24]=o("span",null,"输入 Token",-1)),o("strong",null,_(p.value.input_tokens),1)]),o("div",Ve,[e[25]||(e[25]=o("span",null,"输出 Token",-1)),o("strong",null,_(p.value.output_tokens),1)]),o("div",xe,[e[26]||(e[26]=o("span",null,"总 Token",-1)),o("strong",null,_(p.value.total_tokens),1)]),o("div",Ce,[e[27]||(e[27]=o("span",null,"额度",-1)),o("strong",null,_(p.value.unlimited?"无限":p.value.quota),1)]),o("div",Ue,[e[28]||(e[28]=o("span",null,"剩余额度",-1)),o("strong",null,_(p.value.unlimited?"无限":p.value.remaining),1)]),o("div",qe,[e[29]||(e[29]=o("span",null,"过期时间",-1)),o("strong",null,_(p.value.expire_at||"不过期"),1)])])):B("",!0)]),_:1},8,["modelValue"])])}}},Be=oe($e,[["__scopeId","data-v-26b6cef9"]]);export{Be as default};
